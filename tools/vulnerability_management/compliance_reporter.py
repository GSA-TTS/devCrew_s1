"""
Compliance Reporter - OWASP Top 10, CWE Top 25, PCI DSS mapping and reports.

Maps vulnerabilities to compliance frameworks and generates reports.
"""

import json
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
from pathlib import Path
from typing import Any, Dict, List, Optional

from .vulnerability_aggregator import Severity, Vulnerability


class ComplianceFramework(Enum):
    """Supported compliance frameworks."""

    OWASP_TOP_10 = "owasp_top_10"
    CWE_TOP_25 = "cwe_top_25"
    PCI_DSS = "pci_dss"
    NIST_CSF = "nist_csf"


# OWASP Top 10 2021 mapping
OWASP_TOP_10_2021: Dict[str, Dict[str, Any]] = {
    "A01:2021": {
        "name": "Broken Access Control",
        "cwes": [22, 23, 35, 59, 200, 201, 219, 264, 275, 276, 284, 285, 352, 359, 377, 402, 425, 441, 497, 538, 540, 548, 552, 566, 601, 639, 651, 668, 706, 862, 863, 913, 922, 1275],
    },
    "A02:2021": {
        "name": "Cryptographic Failures",
        "cwes": [261, 296, 310, 319, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 331, 335, 336, 337, 338, 340, 347, 523, 720, 757, 759, 760, 780, 818, 916],
    },
    "A03:2021": {
        "name": "Injection",
        "cwes": [20, 74, 75, 77, 78, 79, 80, 83, 87, 88, 89, 90, 91, 93, 94, 95, 96, 97, 98, 99, 100, 113, 116, 138, 184, 470, 471, 564, 610, 643, 644, 652, 917],
    },
    "A04:2021": {
        "name": "Insecure Design",
        "cwes": [73, 183, 209, 213, 235, 256, 257, 266, 269, 280, 311, 312, 313, 316, 419, 430, 434, 444, 451, 472, 501, 522, 525, 539, 579, 598, 602, 642, 646, 650, 653, 656, 657, 799, 807, 840, 841, 927, 1021, 1173],
    },
    "A05:2021": {
        "name": "Security Misconfiguration",
        "cwes": [2, 11, 13, 15, 16, 260, 315, 520, 526, 537, 541, 547, 611, 614, 756, 776, 942, 1004, 1032, 1174],
    },
    "A06:2021": {
        "name": "Vulnerable and Outdated Components",
        "cwes": [937, 1035, 1104],
    },
    "A07:2021": {
        "name": "Identification and Authentication Failures",
        "cwes": [255, 259, 287, 288, 290, 294, 295, 297, 300, 302, 304, 306, 307, 346, 384, 521, 613, 620, 640, 798, 940, 1216],
    },
    "A08:2021": {
        "name": "Software and Data Integrity Failures",
        "cwes": [345, 353, 426, 494, 502, 565, 784, 829, 830, 915],
    },
    "A09:2021": {
        "name": "Security Logging and Monitoring Failures",
        "cwes": [117, 223, 532, 778],
    },
    "A10:2021": {
        "name": "Server-Side Request Forgery",
        "cwes": [918],
    },
}

# CWE Top 25 2023
CWE_TOP_25_2023: Dict[int, Dict[str, Any]] = {
    787: {"name": "Out-of-bounds Write", "rank": 1},
    79: {"name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')", "rank": 2},
    89: {"name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')", "rank": 3},
    416: {"name": "Use After Free", "rank": 4},
    78: {"name": "Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')", "rank": 5},
    20: {"name": "Improper Input Validation", "rank": 6},
    125: {"name": "Out-of-bounds Read", "rank": 7},
    22: {"name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')", "rank": 8},
    352: {"name": "Cross-Site Request Forgery (CSRF)", "rank": 9},
    434: {"name": "Unrestricted Upload of File with Dangerous Type", "rank": 10},
    862: {"name": "Missing Authorization", "rank": 11},
    476: {"name": "NULL Pointer Dereference", "rank": 12},
    287: {"name": "Improper Authentication", "rank": 13},
    190: {"name": "Integer Overflow or Wraparound", "rank": 14},
    502: {"name": "Deserialization of Untrusted Data", "rank": 15},
    77: {"name": "Improper Neutralization of Special Elements used in a Command ('Command Injection')", "rank": 16},
    119: {"name": "Improper Restriction of Operations within the Bounds of a Memory Buffer", "rank": 17},
    798: {"name": "Use of Hard-coded Credentials", "rank": 18},
    918: {"name": "Server-Side Request Forgery (SSRF)", "rank": 19},
    306: {"name": "Missing Authentication for Critical Function", "rank": 20},
    362: {"name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')", "rank": 21},
    269: {"name": "Improper Privilege Management", "rank": 22},
    94: {"name": "Improper Control of Generation of Code ('Code Injection')", "rank": 23},
    863: {"name": "Incorrect Authorization", "rank": 24},
    276: {"name": "Incorrect Default Permissions", "rank": 25},
}

# PCI DSS v4.0 Requirements mapping
PCI_DSS_REQUIREMENTS: Dict[str, Dict[str, Any]] = {
    "6.2": {
        "name": "Bespoke and Custom Software Security",
        "cwes": [20, 22, 77, 78, 79, 89, 94, 287, 352, 434, 502, 918],
    },
    "6.3": {
        "name": "Security Vulnerabilities Identified and Addressed",
        "cwes": [937, 1035, 1104],  # Vulnerable components
    },
    "6.4": {
        "name": "Public-facing Web Applications Protected",
        "cwes": [79, 89, 352, 918],
    },
    "6.5": {
        "name": "Changes to All System Components Managed Securely",
        "cwes": [276, 284, 285, 862, 863],
    },
    "8.2": {
        "name": "User Identification and Authentication",
        "cwes": [255, 259, 287, 306, 521, 798],
    },
    "8.3": {
        "name": "Strong Authentication for Users and Administrators",
        "cwes": [287, 307, 384, 521, 613, 620],
    },
}


@dataclass
class ComplianceMapping:
    """Maps a vulnerability to compliance requirements."""

    vulnerability: Vulnerability
    owasp_categories: List[str]
    cwe_top_25_rank: Optional[int]
    pci_dss_requirements: List[str]


class ComplianceReporter:
    """Generate compliance reports for vulnerabilities."""

    def __init__(self) -> None:
        """Initialize reporter."""
        self._mappings: List[ComplianceMapping] = []

    def map_vulnerability(self, vulnerability: Vulnerability) -> ComplianceMapping:
        """Map a vulnerability to compliance frameworks."""
        cwe_num = self._extract_cwe_number(vulnerability.cwe_id)

        # Map to OWASP Top 10
        owasp_cats = []
        if cwe_num:
            for cat_id, cat_info in OWASP_TOP_10_2021.items():
                if cwe_num in cat_info["cwes"]:
                    owasp_cats.append(f"{cat_id} - {cat_info['name']}")

        # Map to CWE Top 25
        cwe_rank = None
        if cwe_num and cwe_num in CWE_TOP_25_2023:
            cwe_rank = CWE_TOP_25_2023[cwe_num]["rank"]

        # Map to PCI DSS
        pci_reqs = []
        if cwe_num:
            for req_id, req_info in PCI_DSS_REQUIREMENTS.items():
                if cwe_num in req_info["cwes"]:
                    pci_reqs.append(f"{req_id} - {req_info['name']}")

        mapping = ComplianceMapping(
            vulnerability=vulnerability,
            owasp_categories=owasp_cats,
            cwe_top_25_rank=cwe_rank,
            pci_dss_requirements=pci_reqs,
        )

        self._mappings.append(mapping)
        return mapping

    def map_vulnerabilities(
        self, vulnerabilities: List[Vulnerability]
    ) -> List[ComplianceMapping]:
        """Map multiple vulnerabilities to compliance frameworks."""
        return [self.map_vulnerability(v) for v in vulnerabilities]

    def _extract_cwe_number(self, cwe_id: Optional[str]) -> Optional[int]:
        """Extract numeric CWE ID."""
        if not cwe_id:
            return None
        try:
            return int(cwe_id.replace("CWE-", "").replace("cwe-", ""))
        except ValueError:
            return None

    def generate_owasp_report(
        self, vulnerabilities: List[Vulnerability]
    ) -> Dict[str, Any]:
        """Generate OWASP Top 10 compliance report."""
        self.map_vulnerabilities(vulnerabilities)

        categories: Dict[str, List[Dict[str, Any]]] = {
            cat_id: [] for cat_id in OWASP_TOP_10_2021
        }
        unmapped: List[Dict[str, Any]] = []

        for mapping in self._mappings:
            vuln_summary = {
                "id": mapping.vulnerability.vuln_id,
                "title": mapping.vulnerability.title,
                "severity": mapping.vulnerability.severity.value,
                "cwe_id": mapping.vulnerability.cwe_id,
            }

            if mapping.owasp_categories:
                for cat in mapping.owasp_categories:
                    cat_id = cat.split(" - ")[0]
                    if cat_id in categories:
                        categories[cat_id].append(vuln_summary)
            else:
                unmapped.append(vuln_summary)

        report = {
            "framework": "OWASP Top 10 2021",
            "generated_at": datetime.now().isoformat(),
            "total_vulnerabilities": len(vulnerabilities),
            "categories": {},
            "unmapped_count": len(unmapped),
        }

        for cat_id, cat_info in OWASP_TOP_10_2021.items():
            vulns = categories[cat_id]
            report["categories"][cat_id] = {
                "name": cat_info["name"],
                "count": len(vulns),
                "vulnerabilities": vulns,
            }

        return report

    def generate_cwe_report(
        self, vulnerabilities: List[Vulnerability]
    ) -> Dict[str, Any]:
        """Generate CWE Top 25 compliance report."""
        self.map_vulnerabilities(vulnerabilities)

        top_25_hits: Dict[int, List[Dict[str, Any]]] = {}
        other_cwes: List[Dict[str, Any]] = []

        for mapping in self._mappings:
            vuln_summary = {
                "id": mapping.vulnerability.vuln_id,
                "title": mapping.vulnerability.title,
                "severity": mapping.vulnerability.severity.value,
            }

            if mapping.cwe_top_25_rank:
                cwe_num = self._extract_cwe_number(mapping.vulnerability.cwe_id)
                if cwe_num:
                    if cwe_num not in top_25_hits:
                        top_25_hits[cwe_num] = []
                    top_25_hits[cwe_num].append(vuln_summary)
            else:
                other_cwes.append(vuln_summary)

        report = {
            "framework": "CWE Top 25 2023",
            "generated_at": datetime.now().isoformat(),
            "total_vulnerabilities": len(vulnerabilities),
            "top_25_findings": {},
            "other_findings_count": len(other_cwes),
        }

        for cwe_num, cwe_info in CWE_TOP_25_2023.items():
            vulns = top_25_hits.get(cwe_num, [])
            report["top_25_findings"][f"CWE-{cwe_num}"] = {
                "rank": cwe_info["rank"],
                "name": cwe_info["name"],
                "count": len(vulns),
                "vulnerabilities": vulns,
            }

        return report

    def generate_pci_dss_report(
        self, vulnerabilities: List[Vulnerability]
    ) -> Dict[str, Any]:
        """Generate PCI DSS compliance report."""
        self.map_vulnerabilities(vulnerabilities)

        requirements: Dict[str, List[Dict[str, Any]]] = {
            req_id: [] for req_id in PCI_DSS_REQUIREMENTS
        }

        for mapping in self._mappings:
            vuln_summary = {
                "id": mapping.vulnerability.vuln_id,
                "title": mapping.vulnerability.title,
                "severity": mapping.vulnerability.severity.value,
                "cwe_id": mapping.vulnerability.cwe_id,
            }

            for req in mapping.pci_dss_requirements:
                req_id = req.split(" - ")[0]
                if req_id in requirements:
                    requirements[req_id].append(vuln_summary)

        report = {
            "framework": "PCI DSS v4.0",
            "generated_at": datetime.now().isoformat(),
            "total_vulnerabilities": len(vulnerabilities),
            "requirements": {},
            "compliance_status": {},
        }

        for req_id, req_info in PCI_DSS_REQUIREMENTS.items():
            vulns = requirements[req_id]
            status = "compliant" if len(vulns) == 0 else "non-compliant"
            report["requirements"][req_id] = {
                "name": req_info["name"],
                "finding_count": len(vulns),
                "status": status,
                "vulnerabilities": vulns,
            }
            report["compliance_status"][req_id] = status

        return report

    def generate_executive_summary(
        self, vulnerabilities: List[Vulnerability]
    ) -> Dict[str, Any]:
        """Generate executive summary across all frameworks."""
        owasp = self.generate_owasp_report(vulnerabilities)
        cwe = self.generate_cwe_report(vulnerabilities)
        pci = self.generate_pci_dss_report(vulnerabilities)

        # Count affected categories
        owasp_affected = sum(
            1 for cat in owasp["categories"].values() if cat["count"] > 0
        )
        cwe_top25_affected = sum(
            1 for f in cwe["top_25_findings"].values() if f["count"] > 0
        )
        pci_non_compliant = sum(
            1 for status in pci["compliance_status"].values() if status == "non-compliant"
        )

        severity_counts = {s.value: 0 for s in Severity}
        for v in vulnerabilities:
            severity_counts[v.severity.value] += 1

        return {
            "generated_at": datetime.now().isoformat(),
            "total_vulnerabilities": len(vulnerabilities),
            "severity_distribution": severity_counts,
            "frameworks": {
                "owasp_top_10": {
                    "categories_affected": owasp_affected,
                    "total_categories": 10,
                },
                "cwe_top_25": {
                    "weaknesses_found": cwe_top25_affected,
                    "total_weaknesses": 25,
                },
                "pci_dss": {
                    "requirements_non_compliant": pci_non_compliant,
                    "total_requirements": len(PCI_DSS_REQUIREMENTS),
                },
            },
            "risk_rating": self._calculate_risk_rating(vulnerabilities),
            "recommendations": self._generate_recommendations(owasp, cwe, pci),
        }

    def _calculate_risk_rating(self, vulnerabilities: List[Vulnerability]) -> str:
        """Calculate overall risk rating."""
        if not vulnerabilities:
            return "low"

        critical = sum(1 for v in vulnerabilities if v.severity == Severity.CRITICAL)
        high = sum(1 for v in vulnerabilities if v.severity == Severity.HIGH)

        if critical > 0:
            return "critical"
        elif high > 3:
            return "high"
        elif high > 0:
            return "medium"
        else:
            return "low"

    def _generate_recommendations(
        self,
        owasp: Dict[str, Any],
        cwe: Dict[str, Any],
        pci: Dict[str, Any],
    ) -> List[str]:
        """Generate prioritized recommendations."""
        recommendations = []

        # Priority based on OWASP categories
        priority_order = ["A01:2021", "A02:2021", "A03:2021", "A07:2021"]
        for cat_id in priority_order:
            if owasp["categories"][cat_id]["count"] > 0:
                name = owasp["categories"][cat_id]["name"]
                count = owasp["categories"][cat_id]["count"]
                recommendations.append(
                    f"Address {count} vulnerability(s) related to {name} ({cat_id})"
                )

        # PCI DSS non-compliance
        for req_id, status in pci["compliance_status"].items():
            if status == "non-compliant":
                name = pci["requirements"][req_id]["name"]
                recommendations.append(
                    f"Remediate findings affecting PCI DSS Requirement {req_id}: {name}"
                )

        return recommendations[:5]  # Top 5 recommendations

    def export_report(
        self,
        report: Dict[str, Any],
        file_path: str,
        format: str = "json",
    ) -> None:
        """Export report to file."""
        path = Path(file_path)

        if format == "json":
            with open(path, "w", encoding="utf-8") as f:
                json.dump(report, f, indent=2)
        else:
            raise ValueError(f"Unsupported format: {format}")
