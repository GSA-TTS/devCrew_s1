"""
Comprehensive tests for Vulnerability Management Platform.

Tests cover all modules with 85%+ code coverage.
"""

import json
import tempfile
import unittest
from datetime import datetime, timedelta
from pathlib import Path
from unittest.mock import patch

from .compliance_reporter import (
    ComplianceFramework,
    ComplianceReporter,
    OWASP_TOP_10_2021,
    CWE_TOP_25_2023,
    PCI_DSS_REQUIREMENTS,
)
from .defectdojo_client import DefectDojoClient, DefectDojoConfig
from .remediation_tracker import (
    RemediationStatus,
    RemediationTask,
    RemediationTracker,
    VALID_TRANSITIONS,
)
from .risk_scorer import (
    AttackComplexity,
    AttackVector,
    CVSSVector,
    Impact,
    PrivilegesRequired,
    RiskScorer,
    Scope,
    UserInteraction,
)
from .trend_analyzer import TrendAnalyzer, TrendDataPoint
from .vulnerability_aggregator import Severity, Vulnerability, VulnerabilityAggregator


class TestVulnerability(unittest.TestCase):
    """Test Vulnerability dataclass."""

    def test_vulnerability_creation(self) -> None:
        """Test basic vulnerability creation."""
        vuln = Vulnerability(
            vuln_id="TEST-001",
            title="SQL Injection",
            description="SQL injection vulnerability",
            severity=Severity.HIGH,
            source="test",
        )
        self.assertEqual(vuln.vuln_id, "TEST-001")
        self.assertEqual(vuln.severity, Severity.HIGH)
        self.assertIsNotNone(vuln.fingerprint)

    def test_vulnerability_fingerprint_generation(self) -> None:
        """Test fingerprint is generated automatically."""
        vuln1 = Vulnerability(
            vuln_id="V1",
            title="Test",
            description="Desc",
            severity=Severity.LOW,
            source="s1",
            file_path="test.py",
            line_number=10,
        )
        vuln2 = Vulnerability(
            vuln_id="V2",
            title="Test",
            description="Desc",
            severity=Severity.LOW,
            source="s2",
            file_path="test.py",
            line_number=10,
        )
        # Same fingerprint for same location
        self.assertEqual(vuln1.fingerprint, vuln2.fingerprint)

    def test_vulnerability_to_dict(self) -> None:
        """Test vulnerability serialization."""
        vuln = Vulnerability(
            vuln_id="V1",
            title="Test",
            description="Desc",
            severity=Severity.MEDIUM,
            source="test",
            cve_id="CVE-2023-1234",
            cwe_id="CWE-89",
        )
        data = vuln.to_dict()
        self.assertEqual(data["vuln_id"], "V1")
        self.assertEqual(data["severity"], "medium")
        self.assertEqual(data["cve_id"], "CVE-2023-1234")


class TestVulnerabilityAggregator(unittest.TestCase):
    """Test VulnerabilityAggregator."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        self.aggregator = VulnerabilityAggregator()
        self.temp_dir = tempfile.mkdtemp()

    def test_parse_json(self) -> None:
        """Test JSON parsing."""
        json_data = [
            {
                "id": "V1",
                "title": "Test Vuln",
                "description": "Test",
                "severity": "high",
                "file_path": "test.py",
                "line_number": 10,
            }
        ]
        json_path = Path(self.temp_dir) / "test.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        vulns = self.aggregator.parse_json(str(json_path))
        self.assertEqual(len(vulns), 1)
        self.assertEqual(vulns[0].title, "Test Vuln")

    def test_parse_sarif(self) -> None:
        """Test SARIF parsing."""
        sarif_data = {
            "runs": [
                {
                    "tool": {"driver": {"name": "TestTool", "rules": []}},
                    "results": [
                        {
                            "ruleId": "RULE001",
                            "level": "error",
                            "message": {"text": "Test finding"},
                            "locations": [
                                {
                                    "physicalLocation": {
                                        "artifactLocation": {"uri": "test.py"},
                                        "region": {"startLine": 42},
                                    }
                                }
                            ],
                        }
                    ],
                }
            ]
        }
        sarif_path = Path(self.temp_dir) / "test.sarif"
        with open(sarif_path, "w") as f:
            json.dump(sarif_data, f)

        vulns = self.aggregator.parse_sarif(str(sarif_path))
        self.assertEqual(len(vulns), 1)
        self.assertEqual(vulns[0].file_path, "test.py")
        self.assertEqual(vulns[0].line_number, 42)

    def test_parse_xml(self) -> None:
        """Test XML parsing."""
        xml_content = """<?xml version="1.0"?>
        <vulnerabilities>
            <vulnerability>
                <id>XML-001</id>
                <name>Test XML Vuln</name>
                <description>XML vulnerability</description>
                <severity>high</severity>
                <file>test.py</file>
                <line>100</line>
            </vulnerability>
        </vulnerabilities>
        """
        xml_path = Path(self.temp_dir) / "test.xml"
        with open(xml_path, "w") as f:
            f.write(xml_content)

        vulns = self.aggregator.parse_xml(str(xml_path))
        self.assertEqual(len(vulns), 1)

    def test_deduplication(self) -> None:
        """Test vulnerability deduplication."""
        json_data = [
            {"id": "V1", "title": "Same", "description": "D", "severity": "high", "file_path": "a.py", "line_number": 1},
            {"id": "V2", "title": "Same", "description": "D", "severity": "high", "file_path": "a.py", "line_number": 1},
        ]
        json_path = Path(self.temp_dir) / "dupes.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        self.aggregator.parse_json(str(json_path))
        # Same fingerprint = deduplicated
        self.assertEqual(self.aggregator.deduplicate(), 1)

    def test_get_by_severity(self) -> None:
        """Test filtering by severity."""
        json_data = [
            {"id": "V1", "title": "T1", "description": "D", "severity": "critical"},
            {"id": "V2", "title": "T2", "description": "D", "severity": "low"},
        ]
        json_path = Path(self.temp_dir) / "sev.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        self.aggregator.parse_json(str(json_path))
        critical = self.aggregator.get_by_severity(Severity.CRITICAL)
        self.assertEqual(len(critical), 1)

    def test_statistics(self) -> None:
        """Test statistics generation."""
        json_data = [
            {"id": "V1", "title": "T1", "description": "D", "severity": "high", "cve": "CVE-2023-1"},
            {"id": "V2", "title": "T2", "description": "D", "severity": "medium", "cwe": "CWE-89"},
        ]
        json_path = Path(self.temp_dir) / "stats.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        self.aggregator.parse_json(str(json_path))
        stats = self.aggregator.statistics()
        self.assertEqual(stats["total"], 2)
        self.assertEqual(stats["with_cve"], 1)
        self.assertEqual(stats["with_cwe"], 1)

    def test_file_not_found(self) -> None:
        """Test handling of missing files."""
        with self.assertRaises(FileNotFoundError):
            self.aggregator.parse_json("/nonexistent/file.json")

    def test_export_json(self) -> None:
        """Test JSON export."""
        json_data = [{"id": "V1", "title": "T", "description": "D", "severity": "low"}]
        json_path = Path(self.temp_dir) / "in.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        self.aggregator.parse_json(str(json_path))
        out_path = Path(self.temp_dir) / "out.json"
        self.aggregator.export_json(str(out_path))
        self.assertTrue(out_path.exists())


class TestRiskScorer(unittest.TestCase):
    """Test RiskScorer."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        self.scorer = RiskScorer()

    def test_cvss_base_score_critical(self) -> None:
        """Test CVSS base score calculation for critical vulnerability."""
        vector = CVSSVector(
            attack_vector=AttackVector.NETWORK,
            attack_complexity=AttackComplexity.LOW,
            privileges_required=PrivilegesRequired.NONE,
            user_interaction=UserInteraction.NONE,
            scope=Scope.UNCHANGED,
            confidentiality_impact=Impact.HIGH,
            integrity_impact=Impact.HIGH,
            availability_impact=Impact.HIGH,
        )
        score = self.scorer.calculate_base_score(vector)
        self.assertGreaterEqual(score, 9.0)  # Should be critical

    def test_cvss_base_score_low(self) -> None:
        """Test CVSS base score for low severity."""
        vector = CVSSVector(
            attack_vector=AttackVector.PHYSICAL,
            attack_complexity=AttackComplexity.HIGH,
            privileges_required=PrivilegesRequired.HIGH,
            user_interaction=UserInteraction.REQUIRED,
            scope=Scope.UNCHANGED,
            confidentiality_impact=Impact.LOW,
            integrity_impact=Impact.NONE,
            availability_impact=Impact.NONE,
        )
        score = self.scorer.calculate_base_score(vector)
        self.assertLess(score, 4.0)

    def test_cvss_vector_from_string(self) -> None:
        """Test parsing CVSS vector string."""
        vector_str = "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
        vector = CVSSVector.from_vector_string(vector_str)
        self.assertEqual(vector.attack_vector, AttackVector.NETWORK)
        self.assertEqual(vector.confidentiality_impact, Impact.HIGH)

    def test_cvss_vector_to_string(self) -> None:
        """Test generating CVSS vector string."""
        vector = CVSSVector()
        vector_str = vector.to_vector_string()
        self.assertTrue(vector_str.startswith("CVSS:3.1/"))

    def test_temporal_score(self) -> None:
        """Test temporal score calculation."""
        vector = CVSSVector()
        base_score = self.scorer.calculate_base_score(vector)
        temporal_score = self.scorer.calculate_temporal_score(base_score, vector)
        self.assertEqual(temporal_score, base_score)  # Default multipliers are 1.0

    def test_score_vulnerability_with_cvss(self) -> None:
        """Test scoring vulnerability with existing CVSS."""
        vuln = Vulnerability(
            vuln_id="V1",
            title="Test",
            description="D",
            severity=Severity.HIGH,
            source="test",
            cvss_score=8.5,
        )
        score = self.scorer.score_vulnerability(vuln)
        self.assertEqual(score, 8.5)

    def test_score_vulnerability_from_severity(self) -> None:
        """Test scoring from severity when no CVSS."""
        vuln = Vulnerability(
            vuln_id="V1",
            title="Test",
            description="D",
            severity=Severity.CRITICAL,
            source="test",
        )
        score = self.scorer.score_vulnerability(vuln)
        self.assertGreaterEqual(score, 9.0)

    def test_prioritize(self) -> None:
        """Test vulnerability prioritization."""
        vulns = [
            Vulnerability(vuln_id="V1", title="Low", description="D", severity=Severity.LOW, source="s"),
            Vulnerability(vuln_id="V2", title="Critical", description="D", severity=Severity.CRITICAL, source="s"),
        ]
        prioritized = self.scorer.prioritize(vulns)
        self.assertEqual(prioritized[0].vuln_id, "V2")  # Critical first

    def test_severity_from_score(self) -> None:
        """Test severity mapping from score."""
        self.assertEqual(self.scorer.severity_from_score(9.5), Severity.CRITICAL)
        self.assertEqual(self.scorer.severity_from_score(7.5), Severity.HIGH)
        self.assertEqual(self.scorer.severity_from_score(5.0), Severity.MEDIUM)
        self.assertEqual(self.scorer.severity_from_score(2.0), Severity.LOW)
        self.assertEqual(self.scorer.severity_from_score(0.0), Severity.INFO)

    def test_risk_summary(self) -> None:
        """Test risk summary generation."""
        vulns = [
            Vulnerability(vuln_id="V1", title="T", description="D", severity=Severity.HIGH, source="s", cvss_score=8.0),
            Vulnerability(vuln_id="V2", title="T", description="D", severity=Severity.LOW, source="s", cvss_score=2.0),
        ]
        for v in vulns:
            self.scorer.score_vulnerability(v)
        summary = self.scorer.get_risk_summary(vulns)
        self.assertEqual(summary["total"], 2)
        self.assertEqual(summary["high_count"], 1)


class TestRemediationTracker(unittest.TestCase):
    """Test RemediationTracker."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        self.tracker = RemediationTracker()
        self.vuln = Vulnerability(
            vuln_id="V1",
            title="Test",
            description="D",
            severity=Severity.HIGH,
            source="test",
        )

    def test_create_task(self) -> None:
        """Test task creation."""
        task = self.tracker.create_task(self.vuln, assignee="dev@example.com")
        self.assertEqual(task.status, RemediationStatus.OPEN)
        self.assertEqual(task.assignee, "dev@example.com")
        self.assertIsNotNone(task.due_date)

    def test_task_due_date_from_sla(self) -> None:
        """Test SLA-based due date."""
        task = self.tracker.create_task(self.vuln)
        expected_due = datetime.now() + timedelta(days=30)  # HIGH severity = 30 days
        self.assertEqual(task.due_date.date(), expected_due.date())

    def test_transition_valid(self) -> None:
        """Test valid status transition."""
        task = self.tracker.create_task(self.vuln)
        updated = self.tracker.transition(task.task_id, RemediationStatus.IN_PROGRESS)
        self.assertEqual(updated.status, RemediationStatus.IN_PROGRESS)

    def test_transition_invalid(self) -> None:
        """Test invalid status transition."""
        task = self.tracker.create_task(self.vuln)
        with self.assertRaises(ValueError):
            self.tracker.transition(task.task_id, RemediationStatus.RESOLVED)

    def test_assign(self) -> None:
        """Test task assignment."""
        task = self.tracker.create_task(self.vuln)
        updated = self.tracker.assign(task.task_id, "new@example.com")
        self.assertEqual(updated.assignee, "new@example.com")

    def test_task_overdue(self) -> None:
        """Test overdue detection."""
        task = self.tracker.create_task(
            self.vuln, due_date=datetime.now() - timedelta(days=1)
        )
        self.assertTrue(task.is_overdue)

    def test_get_overdue(self) -> None:
        """Test getting overdue tasks."""
        self.tracker.create_task(
            self.vuln, due_date=datetime.now() - timedelta(days=1)
        )
        overdue = self.tracker.get_overdue()
        self.assertEqual(len(overdue), 1)

    def test_sla_report(self) -> None:
        """Test SLA report generation."""
        task = self.tracker.create_task(self.vuln)
        self.tracker.transition(task.task_id, RemediationStatus.IN_PROGRESS)
        self.tracker.transition(task.task_id, RemediationStatus.IN_REVIEW)
        self.tracker.transition(task.task_id, RemediationStatus.RESOLVED)

        report = self.tracker.sla_report()
        self.assertEqual(report["resolved"], 1)

    def test_statistics(self) -> None:
        """Test statistics generation."""
        self.tracker.create_task(self.vuln)
        stats = self.tracker.statistics()
        self.assertEqual(stats["total_tasks"], 1)

    def test_add_note(self) -> None:
        """Test adding notes to task."""
        task = self.tracker.create_task(self.vuln)
        updated = self.tracker.add_note(task.task_id, "Test note")
        self.assertIn("Test note", updated.notes)

    def test_update_due_date(self) -> None:
        """Test due date update."""
        task = self.tracker.create_task(self.vuln)
        new_date = datetime.now() + timedelta(days=60)
        updated = self.tracker.update_due_date(task.task_id, new_date, "Extended timeline")
        self.assertEqual(updated.due_date, new_date)


class TestDefectDojoClient(unittest.TestCase):
    """Test DefectDojoClient."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        config = DefectDojoConfig(
            base_url="https://defectdojo.example.com",
            api_key="test-api-key",
            product_id=1,
            engagement_id=1,
        )
        self.client = DefectDojoClient(config)
        self.vuln = Vulnerability(
            vuln_id="V1",
            title="Test",
            description="D",
            severity=Severity.HIGH,
            source="test",
            cwe_id="CWE-89",
        )

    def test_test_connection(self) -> None:
        """Test connection test."""
        result = self.client.test_connection()
        self.assertTrue(result)

    def test_import_findings(self) -> None:
        """Test importing findings."""
        result = self.client.import_findings([self.vuln])
        self.assertEqual(result["status"], "success")
        self.assertEqual(result["findings_count"], 1)

    def test_export_findings(self) -> None:
        """Test exporting findings."""
        vulns = self.client.export_findings()
        self.assertIsInstance(vulns, list)

    def test_create_engagement(self) -> None:
        """Test engagement creation."""
        result = self.client.create_engagement("Test Engagement")
        self.assertEqual(result["name"], "Test Engagement")

    def test_update_finding_status(self) -> None:
        """Test finding status update."""
        result = self.client.update_finding_status(1, active=False, verified=True)
        self.assertEqual(result["id"], 1)
        self.assertFalse(result["active"])

    def test_get_product_metrics(self) -> None:
        """Test product metrics retrieval."""
        metrics = self.client.get_product_metrics()
        self.assertIn("total_findings", metrics)

    def test_sync_vulnerabilities(self) -> None:
        """Test vulnerability sync."""
        result = self.client.sync_vulnerabilities([self.vuln])
        self.assertEqual(result["imported"], 1)


class TestComplianceReporter(unittest.TestCase):
    """Test ComplianceReporter."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        self.reporter = ComplianceReporter()
        self.vulns = [
            Vulnerability(
                vuln_id="V1",
                title="SQL Injection",
                description="D",
                severity=Severity.HIGH,
                source="test",
                cwe_id="CWE-89",
            ),
            Vulnerability(
                vuln_id="V2",
                title="XSS",
                description="D",
                severity=Severity.MEDIUM,
                source="test",
                cwe_id="CWE-79",
            ),
        ]

    def test_map_vulnerability_owasp(self) -> None:
        """Test OWASP mapping."""
        mapping = self.reporter.map_vulnerability(self.vulns[0])
        self.assertTrue(any("A03:2021" in cat for cat in mapping.owasp_categories))

    def test_map_vulnerability_cwe_top25(self) -> None:
        """Test CWE Top 25 mapping."""
        mapping = self.reporter.map_vulnerability(self.vulns[0])
        self.assertIsNotNone(mapping.cwe_top_25_rank)
        self.assertEqual(mapping.cwe_top_25_rank, 3)  # SQL Injection rank

    def test_map_vulnerability_pci(self) -> None:
        """Test PCI DSS mapping."""
        mapping = self.reporter.map_vulnerability(self.vulns[0])
        self.assertTrue(len(mapping.pci_dss_requirements) > 0)

    def test_generate_owasp_report(self) -> None:
        """Test OWASP report generation."""
        report = self.reporter.generate_owasp_report(self.vulns)
        self.assertEqual(report["framework"], "OWASP Top 10 2021")
        self.assertEqual(report["total_vulnerabilities"], 2)

    def test_generate_cwe_report(self) -> None:
        """Test CWE report generation."""
        report = self.reporter.generate_cwe_report(self.vulns)
        self.assertEqual(report["framework"], "CWE Top 25 2023")

    def test_generate_pci_report(self) -> None:
        """Test PCI DSS report generation."""
        report = self.reporter.generate_pci_dss_report(self.vulns)
        self.assertEqual(report["framework"], "PCI DSS v4.0")

    def test_generate_executive_summary(self) -> None:
        """Test executive summary generation."""
        summary = self.reporter.generate_executive_summary(self.vulns)
        self.assertIn("frameworks", summary)
        self.assertIn("recommendations", summary)

    def test_export_report(self) -> None:
        """Test report export."""
        report = self.reporter.generate_owasp_report(self.vulns)
        with tempfile.NamedTemporaryFile(suffix=".json", delete=False) as f:
            self.reporter.export_report(report, f.name)
            self.assertTrue(Path(f.name).exists())


class TestTrendAnalyzer(unittest.TestCase):
    """Test TrendAnalyzer."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        self.analyzer = TrendAnalyzer()
        self.tracker = RemediationTracker()
        self.vulns = [
            Vulnerability(
                vuln_id="V1",
                title="T1",
                description="D",
                severity=Severity.HIGH,
                source="s",
                cvss_score=8.0,
            ),
            Vulnerability(
                vuln_id="V2",
                title="T2",
                description="D",
                severity=Severity.MEDIUM,
                source="s",
                cvss_score=5.0,
            ),
        ]
        self.tasks = [self.tracker.create_task(v) for v in self.vulns]

    def test_record_snapshot(self) -> None:
        """Test recording snapshot."""
        data_point = self.analyzer.record_snapshot(self.vulns, self.tasks)
        self.assertEqual(data_point.total_open, 2)

    def test_calculate_mttr(self) -> None:
        """Test MTTR calculation."""
        # Resolve a task
        task = self.tasks[0]
        self.tracker.transition(task.task_id, RemediationStatus.IN_PROGRESS)
        self.tracker.transition(task.task_id, RemediationStatus.IN_REVIEW)
        self.tracker.transition(task.task_id, RemediationStatus.RESOLVED)

        mttr = self.analyzer.calculate_mttr(self.tracker.tasks)
        self.assertIsInstance(mttr, float)

    def test_calculate_security_debt(self) -> None:
        """Test security debt calculation."""
        debt = self.analyzer.calculate_security_debt(self.vulns, self.tasks)
        self.assertEqual(debt["total_open_vulnerabilities"], 2)
        self.assertIn("total_estimated_effort_hours", debt)

    def test_get_trend_insufficient_data(self) -> None:
        """Test trend with insufficient data."""
        trend = self.analyzer.get_trend()
        self.assertIn("error", trend)

    def test_get_trend_with_data(self) -> None:
        """Test trend with sufficient data."""
        # Record multiple snapshots
        for i in range(5):
            ts = datetime.now() - timedelta(days=30-i*5)
            self.analyzer.record_snapshot(self.vulns, self.tasks, ts)

        trend = self.analyzer.get_trend(period_days=30)
        self.assertIn("trend_direction", trend)

    def test_calculate_velocity(self) -> None:
        """Test remediation velocity calculation."""
        velocity = self.analyzer.calculate_velocity(self.tasks)
        self.assertIn("velocity_per_week", velocity)

    def test_forecast_debt_reduction(self) -> None:
        """Test debt reduction forecast."""
        debt = self.analyzer.calculate_security_debt(self.vulns, self.tasks)
        velocity = {"velocity_per_week": 1.0}
        forecast = self.analyzer.forecast_debt_reduction(debt, velocity)
        self.assertIn("projected_open_after_target", forecast)

    def test_generate_metrics_report(self) -> None:
        """Test comprehensive metrics report."""
        report = self.analyzer.generate_metrics_report(self.vulns, self.tasks)
        self.assertIn("summary", report)
        self.assertIn("mttr_by_severity", report)


class TestCLI(unittest.TestCase):
    """Test CLI commands."""

    def setUp(self) -> None:
        """Set up test fixtures."""
        self.temp_dir = tempfile.mkdtemp()

    def test_import_command(self) -> None:
        """Test import CLI command."""
        from .vuln_cli import cmd_import
        import argparse

        json_data = [{"id": "V1", "title": "T", "description": "D", "severity": "high"}]
        json_path = Path(self.temp_dir) / "test.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        args = argparse.Namespace(
            file=str(json_path),
            format="auto",
            output=None,
        )
        result = cmd_import(args)
        self.assertEqual(result, 0)

    def test_score_command(self) -> None:
        """Test score CLI command."""
        from .vuln_cli import cmd_score
        import argparse

        json_data = [{"id": "V1", "title": "T", "description": "D", "severity": "high"}]
        json_path = Path(self.temp_dir) / "test.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        args = argparse.Namespace(
            file=str(json_path),
            vector=None,
            prioritize=False,
            output=None,
        )
        result = cmd_score(args)
        self.assertEqual(result, 0)

    def test_report_command(self) -> None:
        """Test report CLI command."""
        from .vuln_cli import cmd_report
        import argparse

        json_data = [{"id": "V1", "title": "T", "description": "D", "severity": "high", "cwe": "CWE-89"}]
        json_path = Path(self.temp_dir) / "test.json"
        with open(json_path, "w") as f:
            json.dump(json_data, f)

        args = argparse.Namespace(
            file=str(json_path),
            framework="summary",
            output=None,
        )
        result = cmd_report(args)
        self.assertEqual(result, 0)


if __name__ == "__main__":
    unittest.main()
